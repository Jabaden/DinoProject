<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>DinoProject!</title>
	<script type="text/javascript" src="phaser.js"></script>
        <script type="text/javascript" src="ui.js"></script>
        <script src="player.js"></script>
        <script src="enemies.js"></script>
        
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    
<script type="text/javascript">
//initializes a game
console.log("hello");
var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });
var circle;
var dinoPlayer;
//var badDino;
var playerCircle;
var enemyAlert = false;
var map;
var bg_layer;
var playerCollisionGroup;
var enemyCollisionGroup;
var baddies;
var enemyPool;
function preload() {
    ui.preload(game);
    game.load.image('dinoSelf', 'assets/Dino.png');
    game.load.image('dinoBG', 'assets/Extinction_tri.png');
    game.load.image('diamond', 'assets/diamond.png');
    //game.load.tilemap('map_json', 'assets/test_jungle_40x40_buffer.json', null, Phaser.Tilemap.TILED_JSON);
    //game.load.image('testTiles', 'assets/Jungle_04.png');
    game.load.tilemap('tilemap_0_json', 'assets/tilemap_0.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.tilemap('tilemap_1_json', 'assets/tilemap_1.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.tilemap('tilemap_2_json', 'assets/tilemap_2.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.tilemap('tilemap_3_json', 'assets/tilemap_3.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.tilemap('tilemap_4_json', 'assets/tilemap_4.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.tilemap('tilemap_5_json', 'assets/tilemap_5.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.image('Tiles', 'assets/Tiles.png');
    game.load.audio('swipeSound', 'assets/swordswipe.ogg');
    
}

function create() {
    enemyPool = [];

    // load the testing jungle map:
    //map = game.add.tilemap('map_json');
    //map.addTilesetImage('Jungle_04', 'testTiles');
    game.physics.startSystem(Phaser.Physics.P2JS);
    game.stage.backgroundColor = '#000000';
    
    //choose a random map indexed [0, 1, ..., 5]:
    var map_index = Math.floor( Math.random()*6 );
    map = game.add.tilemap('tilemap_' + map_index + '_json');
    // uncomment to force a particular map (for debugging maybe)
    //map = game.add.tilemap('tilemap_0_json'); 
    map.addTilesetImage('Tiles', 'Tiles');
    
    //layer.resizeWorld();
    // enumerate collidable tile indeces:
    //map.setCollisionByExclusion([0]);
    bg_layer = map.createLayer(0);
    bg_layer.resizeWorld();

    map.setLayer(0);
    map.setCollisionBetween(2, 6, true, 0);
    map.setCollisionBetween(10, 11, true, 0);
    tileObjects = game.physics.p2.convertTilemap(map, bg_layer);
    //bg_layer.debug = true; // highlight collidable tiles
    game.physics.enable(bg_layer);

    console.log(map.collideIndexes);


//    map.setCollision( [5, 6, 12, 13, 31, 32, 33, 39, 40, 46, 47, 53, 54],
//        true, 0, false );

    
    
// hmm
        
    playerCircle = new Phaser.Circle(50,50,120);
    dinoPlayer = new player(game, 'dinoSelf','diamond','swipeSound');
    dinoPlayer.getSprite().width = 30;
    dinoPlayer.getSprite().height = 100;
    dinoPlayer.getSprite().body.setRectangleFromSprite(dinoPlayer.getSprite());
    // game.physics.enable(map, Phaser.Physics.ARCADE);
    game.physics.p2.setImpactEvents(true);
    playerCollisionGroup = game.physics.p2.createCollisionGroup();
    enemyCollisionGroup = game.physics.p2.createCollisionGroup();
    tilesCollisionGroup = game.physics.p2.createCollisionGroup();
    game.physics.p2.updateBoundsCollisionGroup();
    ui.create(game);
    //game.physics.enable(uiColl,Phaser.Physics.P2JS);
    game.physics.p2.restitution = 0.1;
    baddies = game.add.group();
    baddies.enableBody = true;
    baddies.physicsBodyType = Phaser.Physics.P2JS;
    
    for (var i = 0; i < tileObjects.length; i++) {
        var tileBody = tileObjects[i];
        tileBody.setCollisionGroup(tilesCollisionGroup);
        tileBody.collides(playerCollisionGroup);
    }
    
    for (var i = 0; i < 4; i++)
    {
        var eDino = new enemy(game, 'dinoBG', 'diamond', baddies);
        eDino.getSprite().body.setCollisionGroup(enemyCollisionGroup);
        eDino.getSprite().body.collides([enemyCollisionGroup, 
            playerCollisionGroup]);
        enemyPool.push(eDino);
    }
    
    dinoPlayer.getSprite().body.setCollisionGroup(playerCollisionGroup);
    dinoPlayer.getAttack().body.setCollisionGroup(playerCollisionGroup);
    dinoPlayer.getSprite().body.collides(enemyCollisionGroup);
    dinoPlayer.getAttack().body.collides(enemyCollisionGroup);
    dinoPlayer.getSprite().body.collides(tilesCollisionGroup);
    dinoPlayer.getAttack().body.onBeginContact.add(directHit, this);
}

function update() {
   dinoPlayer.update();
   for(var r = 0; r < enemyPool.length; r++)
   {
       enemyPool[r].circleUpdate();
   }
   for(var l = 0; l < enemyPool.length; l++)
   {
       if(Phaser.Circle.intersects(playerCircle,enemyPool[l].getCircle()) === true || enemyAlert === true)
       {
           enemyAlert = true;
           for(var q = 0; q < enemyPool.length; q++)
           {
               accelerateTo(enemyPool[q].getSprite(), dinoPlayer.getSprite(), 60);
           }
           
       }
   }
     
   ui.update(game,100,100,100,100,dinoPlayer);
   playerCircle.x = dinoPlayer.getX(); 
   playerCircle.y = dinoPlayer.getY(); 
   //game.physics.arcade.collide(dinoPlayer.getSprite(), fAid , touching, null, this);
   //game.physics.arcade.collide(dinoPlayer.getSprite(), uiColl, touching, null, this);
   //console.log(Phaser.Circle.intersects(playerCircle, enemyCircle));
   //if(Phaser.Circle.intersects(playerCircle,enemyCircle) == true || enemyAlert == true)
   //{
       //accelerateTo(badDino.getSprite(), dinoPlayer.getSprite(),60);
       //enemyAlert = true;
   //}
   
  }

function render()
{
    for(var j = 0; j < enemyPool.length; j++)
    {
       enemyPool[j].circleRender();
    }
    game.debug.geom(playerCircle,'#cfffff', false);
    game.debug.bodyInfo(dinoPlayer.getSprite(), 32, 32);
    game.debug.body(dinoPlayer.getSprite());
    //game.debug.body(badDino);
}

function accelerateTo(sprite1, sprite2, speed)
{
    if(typeof speed === 'undefined')
    {
        speed = 60;
    }
    var angle = Math.atan2(sprite2.y - sprite1.y, sprite2.x - sprite1.x);
    sprite1.body.rotation = angle + game.math.degToRad(90);
    //might want to try velocity or whatever its called
    sprite1.body.velocity.x = Math.cos(angle) * speed/2;
    sprite1.body.velocity.y = Math.sin(angle) * speed/2;
}

/*function touching(player,other)
{
    console.log("hi there");
    game.stage.backgroundColor = '#992d2d';
}*/
//body is the body you hit
function directHit (body, shapeA, shapeB, equation) 
{
    console.log("direct hit!");
    console.log(body.sprite.health);
    body.sprite.health -= 1;
    if(body.sprite.health <= 0)
    {
        body.sprite.kill();
        for(var a = 0; a < enemyPool.length; a++)
        {
            if(enemyPool[a].getSprite().body === body)
            {
               enemyPool.splice(a, 1);
            }
        }
    }
}
</script>
</body>
</html>
