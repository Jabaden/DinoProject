<!DOCTYPE html>
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>DinoProject!</title>
	<script type="text/javascript" src="phaser.js"></script>
        <script type="text/javascript" src="ui.js"></script>
        <script src="player.js"></script>
        <script src="enemies.js"></script>
        <script src="preloader.js"></script>
        <script src="mainMenu.js"></script>
        
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<audio id ="pauseMusic" src="assets/Extinction Pause Music.ogg" preload = "auto"></audio>
    
    
<script type="text/javascript">
//initializes a game
console.log("hello");
var game = new Phaser.Game(800, 600, Phaser.AUTO, ''); //{ preload: preload, create: create, update: update, render: render });

//var extinction = {};
var circle;
var dinoPlayer;
//var badDino;
var playerCircle;
var enemyAlert = false;
var map;
var bg_layer;
var playerCollisionGroup;
var enemyCollisionGroup;
var baddies;
var enemyPool;
var pauseKey;
var enemyCanAttack = true;

var pauseMusic = new Audio('assets/Extinction Pause Music.ogg');
pauseMusic.addEventListener('ended', function() {
    this.currentTime = 0;
    this.play();
}, false);
 

game.state.add('preloader',preloader);
game.state.add('mainMenu', mainMenu);
game.state.add('main', main);
game.state.start('preloader');


var main = {
    
    
    create: function() {

        enemyPool = [];

        game.physics.startSystem(Phaser.Physics.P2JS);
        game.stage.backgroundColor = '#000000';

        //choose a random map indexed [0, 1, ..., 5]:
        var map_index = Math.floor( Math.random()*6 );
        map = game.add.tilemap('tilemap_' + map_index + '_json');
        map.addTilesetImage('Tiles', 'Tiles');
        bg_layer = map.createLayer(0);
        bg_layer.resizeWorld();
        map.setLayer(0);

        // enumerate collidable tile indeces:
        map.setCollisionBetween(2, 6, true, 0);
        map.setCollisionBetween(10, 11, true, 0);
        tileObjects = game.physics.p2.convertTilemap(map, bg_layer);
        //bg_layer.debug = true; // highlight collidable tiles
        game.physics.enable(bg_layer);

        playerCircle = new Phaser.Circle(50,50,115);
        dinoPlayer = new player(game, 'dinoSelf','playerAttackAni','swipeSound');
        dinoPlayer.getSprite().width = 30;
        dinoPlayer.getSprite().height = 50;
        dinoPlayer.getSprite().body.setRectangleFromSprite(dinoPlayer.getSprite());
        // game.physics.enable(map, Phaser.Physics.ARCADE);
        game.physics.p2.setImpactEvents(true);
        playerCollisionGroup = game.physics.p2.createCollisionGroup();
        enemyCollisionGroup = game.physics.p2.createCollisionGroup();
        tilesCollisionGroup = game.physics.p2.createCollisionGroup();
        game.physics.p2.updateBoundsCollisionGroup();
        ui.create(game);
        //game.physics.enable(uiColl,Phaser.Physics.P2JS);
        game.physics.p2.restitution = 0.1;
        baddies = game.add.group();
        baddies.enableBody = true;
        baddies.physicsBodyType = Phaser.Physics.P2JS;

        for (var i = 0; i < tileObjects.length; i++) {
            var tileBody = tileObjects[i];
            tileBody.setCollisionGroup(tilesCollisionGroup);
            tileBody.collides(playerCollisionGroup);
            tileBody.collides(enemyCollisionGroup);
        }
        //HARDCODING 4 DINOS
        for (var i = 0; i < 4; i++)
        {
            var eDino = new enemy(game, 'dinoBG', 'playerAttackAni', baddies);
            eDino.getSprite().body.setRectangleFromSprite(eDino.getSprite());
            eDino.getSprite().body.setCollisionGroup(enemyCollisionGroup);
            eDino.getSprite().body.collides([enemyCollisionGroup, 
                playerCollisionGroup,tilesCollisionGroup]);
            eDino.getEnemyAttack().body.setCollisionGroup(enemyCollisionGroup);
            eDino.getEnemyAttack().body.collides(playerCollisionGroup);
            enemyPool.push(eDino);
            
            // bug: checking this loop condition occasionally crashes, w/ a complaing about a null reference.
            while (map.getTile(Math.floor(eDino.getX()/40), 
                    Math.floor(eDino.getY()/40), 
                    bg_layer, true).index !== 1) {
                eDino.findNewPos();
            }
            
        }
        for (var c = 0; c < 4; c++)
        {
            enemyPool[c].getEnemyAttack().body.onBeginContact.add(this.attackPlayer, this);
        }
        dinoPlayer.getSprite().body.setCollisionGroup(playerCollisionGroup);
        dinoPlayer.getAttack().body.setCollisionGroup(playerCollisionGroup);
        dinoPlayer.getSprite().body.collides(enemyCollisionGroup);
        dinoPlayer.getAttack().body.collides(enemyCollisionGroup);
        dinoPlayer.getSprite().body.collides(tilesCollisionGroup);
        dinoPlayer.getAttack().body.onBeginContact.add(this.directHit, this);
        
        
       
        
    },
    update: function() {
        
       dinoPlayer.update(map, bg_layer);
       for(var r = 0; r < enemyPool.length; r++)
       {
           enemyPool[r].circleUpdate();
       }
       for(var l = 0; l < enemyPool.length; l++)
       {
           if(Phaser.Circle.intersects(playerCircle,enemyPool[l].getCircle()) === true || enemyAlert === true)
           {
               enemyAlert = true;
               for(var q = 0; q < enemyPool.length; q++)
               {
                   this.accelerateTo(enemyPool[q].getSprite(), dinoPlayer.getSprite(), 60);
               }

           }
           if(Phaser.Circle.intersects(playerCircle,enemyPool[l].getACircle()) === true)
           {
               console.log(enemyPool[l].queryAttack());
               if(enemyPool[l].queryAttack() == true)
               {
                    enemyPool[l].getEnemyAttack().revive();
                    enemyPool[l].getEnemyAttack().animations.stop(true);
                    enemyPool[l].getEnemyAttack().animations.play('attackSwipe', 10, true);
                    enemyPool[l].getEnemyAttack().x = dinoPlayer.getX();
                    enemyPool[l].getEnemyAttack().y = dinoPlayer.getY();
                    enemyPool[l].getEnemyAttack().body.x = dinoPlayer.getX();
                    enemyPool[l].getEnemyAttack().body.y = dinoPlayer.getY();
                    /*enemyPool[l].getEnemyAttack().angle = enemyPool[l].rotation;
                    enemyPool[l].getEnemyAttack().angle = enemyPool[l].rotation;
                    enemyPool[l].getEnemyAttack().body.angle = enemyPool[l].rotation;
                    enemyPool[l].getEnemyAttack().body.angle = enemyPool[l].rotation;*/
                    enemyPool[l].cannotAttack();
                    game.time.events.add(500, enemyPool[l].canAttack, enemyPool[l]);
                    game.time.events.add(300, enemyPool[l].killAttack, enemyPool[l]);
                    console.log("im attacking you!");
                }
           }
       }

       ui.update(game,100,100,100,100,dinoPlayer);
       playerCircle.x = dinoPlayer.getX(); 
       playerCircle.y = dinoPlayer.getY(); 
       //console.log(Phaser.Circle.intersects(playerCircle, enemyCircle));
       //if(Phaser.Circle.intersects(playerCircle,enemyCircle) == true || enemyAlert == true)
       //{
           //accelerateTo(badDino.getSprite(), dinoPlayer.getSprite(),60);
           //enemyAlert = true;
       //}

        
      },
    render: function()
    {
        for(var j = 0; j < enemyPool.length; j++)
        {
           enemyPool[j].circleRender();
        }
        game.debug.geom(playerCircle,'#cfffff', false);
        game.debug.bodyInfo(dinoPlayer.getSprite(), 32, 32);
        game.debug.body(dinoPlayer.getSprite());
        //game.debug.body(badDino);
    },
    accelerateTo: function(sprite1, sprite2, speed)    {
        if(typeof speed === 'undefined')
        {
            speed = 60;
        }
        var angle = Math.atan2(sprite2.y - sprite1.y, sprite2.x - sprite1.x);
        sprite1.body.rotation = angle + game.math.degToRad(90);
        //might want to try velocity or whatever its called
        sprite1.body.velocity.x = Math.cos(angle) * speed/2;
        sprite1.body.velocity.y = Math.sin(angle) * speed/2;
    },
    managePause: function(){
        // When the pause button is pressed, we pause the game
        pauseMusic.play();

        game.paused = true;
        // Then add the menu
        menu = game.add.sprite(0,0, 'pause');
        //unpause game
        resume = game.add.sprite(300, 30, 'resume');
        //restart sprite
        restart = game.add.sprite(290, 120, 'restart');
        //quit sprite
        quit = game.add.sprite(320, 210, 'quit');
        // Add a input listener that can help us return from being paused
        game.input.onDown.add(this.unpause, self);
    },
        // And finally the method that handels the pause menu
    unpause: function(event){
        // Only act if paused
        if(game.paused){
            //the resume sprites bounds
            var resumeX1 = 300, resumeY1 = 30, resumeX2 = 484, resumeY2 = 82;
            //the restart sprites bounds
            var restartX1 = 290, restartY1 = 120, restartX2 = 508, restartY2 = 57;
            //the quit sprites bounds
            var quitX1 = 320, quitY1 = 210, quitX2 = 458, quitY2 = 71;            
            //test if click is in resume
            if(event.x > resumeX1 && event.x < resumeX2 && event.y > resumeY1 && event.y < resumeY2 ){
                console.log(7);
                menu.destroy();
                resume.destroy();
                restart.destroy();
                quit.destroy();
                pauseMusic.currentTime = 0;
                pauseMusic.pause();
                // Unpause the game
                game.paused = false;
            }else if(event.x > restartX1 && event.x < restartX2 && event.y > restartY1 && event.y < restartY2 ){
                //restart the game
                console.log("restart");
            }else if(event.x > quitX1 && event.x < quitX2 && event.y > quitY1 && event.y < quitY2 ){
                //quit to main menu
                console.log("quit");
            }
        }
    },
    /*function touching(player,other)
    {
        console.log("hi there");
        game.stage.backgroundColor = '#992d2d';
    }*/
    //body is the body you hit
    directHit: function(body, shapeA, shapeB, equation) 
    {
        console.log("direct hit!");
        console.log(body.sprite.health);
        body.sprite.health -= 1;
        if(body.sprite.health <= 0)
        {
            body.sprite.kill();
            dinoPlayer.addXP(2);
            for(var a = 0; a < enemyPool.length; a++)
            {
                if(enemyPool[a].getSprite().body === body)
                {
                   enemyPool.splice(a, 1);
                }
            }
        }
    },
    //THIS IS WHAT HAPPENS WHEN THE MONSTERS ATTACK HITS YOU, MANIPULATE STUFF 
    attackPlayer: function(body, shapeA, shapeB, equation) 
    {
        console.log("SMACK YO FACE");
    },
    attackAgain: function()
    {
        enemyCanAttack = true;
    }
   
};
game.state.add('preloader',preloader);
game.state.add('main', main);
game.state.start('preloader');
</script>
</body>
</html>
